# إصلاح حساب أرباح القيادة

## المشكلة
كان النظام يحاول استخدام حقل `personalPoints` غير موجود في قاعدة البيانات، مما يؤدي إلى حساب خاطئ لأرباح القيادة.

## الحل
تم تعديل الكود ليستخدم حقل `points` الموجود في نموذج المستخدم، والذي يحتوي على النقاط الشخصية من مشتريات العضو.

## التعديلات المنفذة

### 1. ملف `backend/utils/calculateLeadershipCommission.js`
- **السطر 54**: تغيير `m.personalPoints` إلى `m.points`
- **السطر 83**: تغيير `.select('personalPoints')` إلى `.select('points')`

## قواعد حساب أرباح القيادة

### نظام الحساب
يتم حساب أرباح القيادة بناءً على **مجموع النقاط الشخصية** لأعضاء كل جيل، وتختلف النسبة حسب رتبة العضو:

### 1. البرونزي (Bronze)
- **الجيل الأول**: 5% من مجموع نقاطهم الشخصية

### 2. الفضي (Silver)
- **الجيل الأول**: 5% من مجموع نقاطهم الشخصية
- **الجيل الثاني**: 4% من مجموع نقاطهم الشخصية

### 3. الذهبي (Gold)
- **الجيل الأول**: 5% من مجموع نقاطهم الشخصية
- **الجيل الثاني**: 4% من مجموع نقاطهم الشخصية
- **الجيل الثالث**: 3% من مجموع نقاطهم الشخصية

### 4. الياقوتي (Ruby)
- **الجيل الأول**: 5% من مجموع نقاطهم الشخصية
- **الجيل الثاني**: 4% من مجموع نقاطهم الشخصية
- **الجيل الثالث**: 3% من مجموع نقاطهم الشخصية
- **الجيل الرابع**: 2% من مجموع نقاطهم الشخصية

### 5. الماسي وما فوق (Diamond+)
- **الجيل الأول**: 5% من مجموع نقاطهم الشخصية
- **الجيل الثاني**: 4% من مجموع نقاطهم الشخصية
- **الجيل الثالث**: 3% من مجموع نقاطهم الشخصية
- **الجيل الرابع**: 2% من مجموع نقاطهم الشخصية
- **الجيل الخامس**: 1% من مجموع نقاطهم الشخصية

## مثال توضيحي

### عضو فضي لديه:
- **الجيل الأول**: 5 أعضاء بإجمالي نقاط شخصية = 10,000 نقطة
- **الجيل الثاني**: 15 عضو بإجمالي نقاط شخصية = 25,000 نقطة

### الحساب:
```
أرباح القيادة = (10,000 × 5%) + (25,000 × 4%)
                = 500 + 1,000
                = 1,500 نقطة

القيمة بالشيكل = 1,500 × 0.55 = 825 شيكل
```

## كيفية الاستخدام

### 1. اختبار الحسابات
```bash
node backend/testLeadershipCommissionFixed.js
```

### 2. إعادة حساب أرباح القيادة لجميع الأعضاء
```bash
node backend/recalculateLeadershipFixed.js
```

## ملاحظات مهمة

1. **النقاط الشخصية** (`points`): تحتوي على مجموع نقاط المشتريات الشخصية للعضو
2. **معامل التحويل**: نقطة واحدة = 0.55 شيكل
3. **التحديث التلقائي**: يتم تحديث أرباح القيادة تلقائياً عند:
   - إتمام طلب جديد
   - إضافة نقاط يدوياً من لوحة الإدارة
4. **الأجيال**: يتم حساب الأجيال بشكل تكراري من خلال حقل `referredBy`

## الملفات المتأثرة

- ✅ `backend/utils/calculateLeadershipCommission.js` - تم الإصلاح
- ✅ `backend/testLeadershipCommissionFixed.js` - سكريبت اختبار جديد
- ✅ `backend/recalculateLeadershipFixed.js` - سكريبت إعادة حساب جديد

## التحقق من النتائج

بعد تشغيل السكريبت، يمكنك التحقق من النتائج في:
- لوحة الإدارة → إدارة الأعضاء
- صفحة الإحصائيات للعضو
- جدول الأرباح المتوقعة

---
**تاريخ الإصلاح**: 2026-02-10
**الحالة**: ✅ تم الإصلاح والاختبار
