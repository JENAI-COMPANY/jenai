const mongoose = require('mongoose');
require('dotenv').config();

mongoose.connect(process.env.MONGODB_URI).then(async () => {
  console.log('========================================');
  console.log('Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙØªØ±Ø© 99 Ø§Ù„ÙØ¹Ù„ÙŠØ©');
  console.log('========================================\n');

  const User = require('./models/User');
  const { calculateLeadershipCommission } = require('./config/memberRanks');

  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø¶Ùˆ T
  const tUser = await User.findOne({ username: 't' });
  
  if (!tUser) {
    console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶Ùˆ T');
    mongoose.disconnect();
    return;
  }

  console.log(`âœ… Ø§Ù„Ø¹Ø¶Ùˆ: ${tUser.name} (@${tUser.username})`);
  console.log(`   Ø§Ù„Ø±ØªØ¨Ø©: ${tUser.memberRank} (ÙŠØ§Ù‚ÙˆØªÙŠ - Ruby)`);
  console.log(`   Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${tUser.monthlyPoints}\n`);

  console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª ÙØªØ±Ø© 99 Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:');
  console.log('   Ø§Ù„Ù†Ù‚Ø§Ø·:');
  console.log('     - Ø¬ÙŠÙ„ 1: 1430 Ù†Ù‚Ø·Ø© (Ø¹Ù…ÙˆÙ„Ø© Ø£Ø¬ÙŠØ§Ù„ Ø¨Ø¹Ø¯ Ù†Ø³Ø¨Ø© 11%)');
  console.log('     - Ø¬ÙŠÙ„ 2: 1912 Ù†Ù‚Ø·Ø© (Ø¹Ù…ÙˆÙ„Ø© Ø£Ø¬ÙŠØ§Ù„ Ø¨Ø¹Ø¯ Ù†Ø³Ø¨Ø© 8%)');
  console.log('     - Ø¬ÙŠÙ„ 3: 300 Ù†Ù‚Ø·Ø© (Ø¹Ù…ÙˆÙ„Ø© Ø£Ø¬ÙŠØ§Ù„ Ø¨Ø¹Ø¯ Ù†Ø³Ø¨Ø© 6%)');
  console.log('     - Ø¬ÙŠÙ„ 4: 120 Ù†Ù‚Ø·Ø© (Ø¹Ù…ÙˆÙ„Ø© Ø£Ø¬ÙŠØ§Ù„ Ø¨Ø¹Ø¯ Ù†Ø³Ø¨Ø© 3%)');
  console.log('   Ù†Ù‚Ø§Ø· Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©: 1836 Ù†Ù‚Ø·Ø©');
  console.log('   Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©: 1009 Ø´ÙŠÙƒÙ„\n');

  console.log('âš ï¸  Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù‡ÙŠ Ù†Ù‚Ø§Ø· Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø£Ø¬ÙŠØ§Ù„ (Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø¨)');
  console.log('   Ù„ÙƒÙ† Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ØªÙØ­Ø³Ø¨ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©\n');

  console.log('========================================');
  console.log('Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø¸Ø±ÙŠ Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ù„Ù„ÙŠØ§Ù‚ÙˆØªÙŠ:');
  console.log('========================================');
  console.log('Ù†Ø³Ø¨ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©: 5%, 4%, 3%, 2%\n');

  // Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù† Ù„Ø£Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ØµÙØ±
  console.log('âš ï¸  Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù† Ù„Ø£Ù†:');
  console.log('   1. Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù„ØµÙØ± Ø¨Ø¹Ø¯ ÙØªØ±Ø© 99');
  console.log('   2. Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙØ±ÙŠÙ‚ Ù‚Ø¯ ØªØºÙŠØ± Ø¨Ø¹Ø¯ ÙØªØ±Ø© 99\n');

  console.log('========================================');
  console.log('Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„ÙØªØ±Ø© 99:');
  console.log('========================================');

  console.log('Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ù‚Ø§Ø· Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© = 1836 Ù†Ù‚Ø·Ø©');
  console.log('Ø§Ù„Ø­Ø³Ø§Ø¨: 1836 Ã— 0.55 = ' + (1836 * 0.55));
  console.log('Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨: Math.floor(' + (1836 * 0.55) + ') = ' + Math.floor(1836 * 0.55) + ' Ø´ÙŠÙƒÙ„');
  console.log('Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø©: 1009 Ø´ÙŠÙƒÙ„');
  console.log(Math.floor(1836 * 0.55) === 1009 ? 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚ - Ø§Ù„Ø­Ø³Ø§Ø¨ ØµØ­ÙŠØ­!' : 'âŒ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚');

  console.log('\n========================================');
  console.log('Ø§Ø®ØªØ¨Ø§Ø± Ø«Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
  console.log('========================================');

  // Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  console.log('\nØ³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§ÙØªØ±Ø§Ø¶ÙŠ:');
  console.log('Ù„Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ø¯ÙŠÙ‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ§Ù„ÙŠØ©:\n');

  const POINTS_TO_SHEKEL = 0.55;
  
  // Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ù†Ù‚Ø§Ø· Ø¨Ø³ÙŠØ·Ø©
  const scenario1 = {
    gen1: 1000,
    gen2: 800,
    gen3: 500,
    gen4: 200
  };

  console.log('Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1:');
  console.log(`  Ø¬ÙŠÙ„ 1: ${scenario1.gen1} Ù†Ù‚Ø·Ø© Ã— 5% = ${scenario1.gen1 * 0.05} Ù†Ù‚Ø·Ø©`);
  console.log(`  Ø¬ÙŠÙ„ 2: ${scenario1.gen2} Ù†Ù‚Ø·Ø© Ã— 4% = ${scenario1.gen2 * 0.04} Ù†Ù‚Ø·Ø©`);
  console.log(`  Ø¬ÙŠÙ„ 3: ${scenario1.gen3} Ù†Ù‚Ø·Ø© Ã— 3% = ${scenario1.gen3 * 0.03} Ù†Ù‚Ø·Ø©`);
  console.log(`  Ø¬ÙŠÙ„ 4: ${scenario1.gen4} Ù†Ù‚Ø·Ø© Ã— 2% = ${scenario1.gen4 * 0.02} Ù†Ù‚Ø·Ø©`);
  
  const totalPoints1 = (scenario1.gen1 * 0.05) + (scenario1.gen2 * 0.04) + (scenario1.gen3 * 0.03) + (scenario1.gen4 * 0.02);
  console.log(`  Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${totalPoints1} Ù†Ù‚Ø·Ø©`);
  console.log(`  Ã— 0.55 = ${totalPoints1 * POINTS_TO_SHEKEL}`);
  console.log(`  Math.floor = ${Math.floor(totalPoints1 * POINTS_TO_SHEKEL)} Ø´ÙŠÙƒÙ„\n`);

  // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø®Ø§Ø·Ø¦Ø©)
  const oldWay1 = Math.floor(scenario1.gen1 * 0.05 * POINTS_TO_SHEKEL) + 
                  Math.floor(scenario1.gen2 * 0.04 * POINTS_TO_SHEKEL) + 
                  Math.floor(scenario1.gen3 * 0.03 * POINTS_TO_SHEKEL) + 
                  Math.floor(scenario1.gen4 * 0.02 * POINTS_TO_SHEKEL);
  
  const newWay1 = Math.floor(totalPoints1 * POINTS_TO_SHEKEL);
  
  console.log(`  Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ØªÙ‚Ø±ÙŠØ¨ ÙƒÙ„ Ø¬ÙŠÙ„): ${oldWay1} Ø´ÙŠÙƒÙ„`);
  console.log(`  Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ): ${newWay1} Ø´ÙŠÙƒÙ„`);
  console.log(`  Ø§Ù„ÙØ±Ù‚: ${Math.abs(newWay1 - oldWay1)} Ø´ÙŠÙƒÙ„ ${newWay1 === oldWay1 ? 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚' : 'âš ï¸  ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚'}\n`);

  console.log('========================================');
  console.log('Ø§Ù„Ø®Ù„Ø§ØµØ©:');
  console.log('========================================');
  console.log('âœ… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠÙ‚ÙˆÙ… Ø¨Ù€:');
  console.log('   1. Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬ÙŠØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹');
  console.log('   2. Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙÙŠ 0.55');
  console.log('   3. ØªÙ‚Ø±ÙŠØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');
  console.log('\nâœ… Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ù†ØªÙŠØ¬Ø© Ø«Ø§Ø¨ØªØ© Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ù†Ù‚Ø§Ø·');
  console.log('âœ… ÙŠÙ…Ù†Ø¹ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ÙƒØ³ÙˆØ± Ø¹Ù†Ø¯ ÙƒÙ„ Ø¬ÙŠÙ„');
  console.log('âœ… Ù„Ù† ÙŠØ­Ø¯Ø« ÙØ±Ù‚ Ø´ÙŠÙƒÙ„ Ø£Ùˆ Ø´ÙŠÙƒÙ„ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†\n');

  mongoose.disconnect();
  console.log('âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡');
}).catch(err => {
  console.error('âŒ Ø®Ø·Ø£:', err);
  process.exit(1);
});
